package service;

import blibliotheque.Bibliotheque;
import blibliotheque.Client;
import blibliotheque.Data;
import blibliotheque.InputWorker;
import blibliotheque.OutputWorker;
import blibliotheque.ServiceServer;

import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.HashMap;

public class RetourServer implements ServiceServer {
	private static final int PORT = 2700;
	private static final String IP = "127.0.0.1";
	private static final String RETOUR_ACTION = "Retour";
	private ServerSocket server;
	private InputWorker input; // to read data
	private OutputWorker output;
	private HashMap<Socket, Client> map; // to store sockets
	private Bibliotheque bi;
	public RetourServer(){
		
	}
	
	@Override
	public void run() {
		// TODO Auto-generated method stub
		if(server != null){// if there was no IOEception, we can start to work
			try {
				System.out.println("Le server est en marche");
				do{
					Socket s = server.accept(); // accept connections
					s.setSoTimeout(1);
					Data d = new Data(s,null, this);
					input.add(d); // put data on the inputworker
					d.setMsg(RETOUR_ACTION + System.getProperty("line.separator") + "Vous êtes connecté(e) sur le serveur"
					+ System.getProperty("line.separator") + " Entrez votre Id pour vous identifier" + System.getProperty("line.separator"));
					output.add(d); // start the communication
					synchronized(map){
						map.put(s, null); // put on the map
						System.out.println("Un nouveau client est accepté, il y en a "+ map.size());
					}
				}while(true);
			} catch (IOException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		
	}

	@Override
	public boolean consume(Data data) {
		// TODO Auto-generated method stub
		String[] array = data.getMsg().split(System.getProperty("line.separator"));
		if(array.length >= 2){
			StringBuilder sb = new StringBuilder();
			for(int i = 1; i < array.length; ++i)
				sb.append(array[i]);
			return matchFunction2(array[0], sb.toString(), data);
		}else
			return false;
	}

	@Override
	public void remove(Socket s) {
		// TODO Auto-generated method stub
		
	}
}
